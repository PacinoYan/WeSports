<!doctype html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <meta charset="UTF-8">
    <meta http-equiv="Access-Control-Allow-Origin" content="*" />
    <script src="jquery.min.js" type="text/javascript"></script>
    <title>WeSports</title>
</head>
<body >
    <style>
        html{
            height:100%;
        }
        body{
            padding: 0;
            margin: 0;
            background: url(background-img.jpg);
            background-size: 100% 100%;
            /* position: absolute; */
        }
        video{
            margin-top: 230px;
            margin-left: -60px;
            border-radius: 50%;
        }
        p {
            height: 50px;
            width: 200px;
            margin-top: 110px;
            margin-left: 200px;
            /* background-color: white; */
            text-align: center;
        }
       
    </style>
    <div class="container">
        <div class="row">
            <div class="col-md-6" >
                <video id="v" style="width: 450px;height: 450px;">
                </video>
                <canvas id="canvas" style="display:none;"></canvas>
            </div>
            <div class="col-md-6" style="margin-top: 150px">
                <p id="identity" class="bg-mute text-success" style="width: auto;height: 30px;font-size:30px;font-weight: bolder">---</p>
                <p id="temperature" class="bg-mute text-success" style="width: auto;height: 30px;font-size:30px;font-weight: bolder" >---</p>
                <p id="health" class="bg-mute text-success" style="width: auto;height: 30px;font-size:30px;font-weight: bolder">---</p>
                <p id="result" class="bg-mute text-success" style="width: auto;height: 30px;font-size:30px;font-weight: bolder">---</p>
            </div>
        </div>
    </div>
    
    <canvas id="canvas" style="display:none;"></canvas>

	<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
	
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
    <script>
        !(function () {
            // 老的浏览器可能根本没有实现 mediaDevices，所以我们可以先设置一个空的对象
            if (navigator.mediaDevices === undefined) {
                navigator.mediaDevices = {};
            }
            if (navigator.mediaDevices.getUserMedia === undefined) {
                navigator.mediaDevices.getUserMedia = function (constraints) {
                    // 首先，如果有getUserMedia的话，就获得它
                    var getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
 
                    // 一些浏览器根本没实现它 - 那么就返回一个error到promise的reject来保持一个统一的接口
                    if (!getUserMedia) {
                        return Promise.reject(new Error('getUserMedia is not implemented in this browser'));
                    }
 
                    // 否则，为老的navigator.getUserMedia方法包裹一个Promise
                    return new Promise(function (resolve, reject) {
                        getUserMedia.call(navigator, constraints, resolve, reject);
                    });
                }
            }
            const constraints = {
                video: true,
                audio: false
            };
            let videoPlaying = false;
            let v = document.getElementById('v');
            let promise = navigator.mediaDevices.getUserMedia(constraints);
            promise.then(stream => {
                // 旧的浏览器可能没有srcObject
                if ("srcObject" in v) {
                    v.srcObject = stream;
                } else {
                    // 防止再新的浏览器里使用它，应为它已经不再支持了
                    v.src = window.URL.createObjectURL(stream);
                }
                v.onloadedmetadata = function (e) {
                    v.play();
                    videoPlaying = true;
                };
            }).catch(err => {
                console.error(err.name + ": " + err.message);
            })
			
			function picture() {
                if (videoPlaying) {
                    let canvas = document.getElementById('canvas');
                    canvas.width = v.videoWidth;
                    canvas.height = v.videoHeight;
                    canvas.getContext('2d').drawImage(v, 0, 0);
                    let data = canvas.toDataURL('image/jpeg');
				
                    // document.getElementById('photo').setAttribute('src', data);
                }
            }

            function handleSave () {
                //导出base64格式的图片数据
                var mycanvas = document.getElementById("canvas");
                var base64Data = mycanvas.toDataURL("image/jpeg", 1.0);
                //封装blob对象
                var blob = dataURItoBlob(base64Data);
                //组装formdata
                var fd = new FormData();

                fd.append("fileData", blob);//fileData为自定义
                fd.append("fileName", "123");//fileName为自定义，名字随机生成或者写死，看需求
                //ajax上传，ajax的形式随意，JQ的写法也没有问题
                //需要注意的是服务端需要设定，允许跨域请求。数据接收的方式和<input type="file"/> 上传的文件没有区别


                // 创建xhr对象
                var xhr = new XMLHttpRequest();


                // xhr.withCredentials = true

                // xhr.setRequestHeader("Access-Control-Allow-Origin", "*")
                // 调用xhr.open()函数
                xhr.open("POST", '/face/validation')
                //调用xhr.send()函数,发送请求,这一步是异步操作
                xhr.send(fd);
                //监听 xhr.onreadystatechange  事件
                xhr.onreadystatechange = function () {

                    if (xhr.readyState === 4 && xhr.status === 200) {
                        console.log(xhr.responseText)
                        var json = JSON.parse(xhr.responseText)

                        if(json != null && json.data != null) {
                            var xReq = new XMLHttpRequest();
                            xReq.open("POST", '/order/check')
                            xReq.setRequestHeader('content-type', 'application/json');
                            var jsonReq = {
                                "userId":json.data.userId,
                                "companyId":10
                            }
                            var data_json = JSON.stringify(jsonReq)

                            xReq.send(data_json)
                            console.log(data_json)

                            xReq.onreadystatechange = function() {
                                if(xhr.readyState === 4 && xhr.status === 200) {
                                    console.log(xReq)
                                    console.log(xReq.responseText);

                                    // console.log(JSON.stringify(xReq.responseText))
                                    try {
                                        var xjson = JSON.parse(xReq.responseText);
                                    }catch(err) {}
                                    console.log(xjson)
                                    if (xjson != null && xjson.data != null && xjson.data.stat !== "-1") {
                                        console.log(xjson.data)
                                        console.log(xjson.data.temp)
                                        document.getElementById("identity").innerText = xjson.data.username
                                        document.getElementById("health").innerText = xjson.data.health
                                        document.getElementById("temperature").innerText = xjson.data.temp
                                        if(xjson.data.stat === "1")
                                            document.getElementById("result").innerText = "健康信息不通过"
                                        else {
                                            document.getElementById("result").innerText = "验票成功"
                                                var sleep = function (time) {
                                                var startTime = new Date().getTime() + parseInt(time,10);
                                                while(new Date().getTime() < startTime) {}
                                            };
                                            sleep(1000)
                                        }

                                    }
                                    else if(xjson != null && xjson.data != null && xjson.data.stat === "-1") {
                                        document.getElementById("identity").innerText = xjson.data.username
                                        document.getElementById("health").innerText = xjson.data.health
                                        document.getElementById("temperature").innerText = xjson.data.temp
                                        document.getElementById("result").innerText = "未购票"
                                    }
                                    else {
                                        document.getElementById("identity").innerText = "---"
                                        document.getElementById("health").innerText = "---"
                                        document.getElementById("temperature").innerText = "---"
                                        document.getElementById("result").innerText = "---"
                                    }
                                }
                                else {
                                    document.getElementById("identity").innerText = "---"
                                    document.getElementById("health").innerText = "---"
                                    document.getElementById("temperature").innerText = "---"
                                    document.getElementById("result").innerText = "---"
                                }
                            }
                        }
                        else {
                            document.getElementById("identity").innerText = "---"
                            document.getElementById("health").innerText = "---"
                            document.getElementById("temperature").innerText = "---"
                            document.getElementById("result").innerText = "---"
                        }



                        // var data = {}
                        // data["userId"] = xhr.responseText.userId
                        // data["companyId"] = "10"
                        // $.ajax({
                        //     tpye:"POST",
                        //     dataType:"json",
                        //     contentType:"application/json;charset=UTF-8",
                        //     url:"/api/v1/check",
                        //     data:JSON.stringify(data),
                        //     success:function(data){
                        //         console.log(data)
                        //     }
                        // });
                    }
                }
            };
			function dataURItoBlob (base64Data) {
				var byteString;
				if (base64Data.split(',')[0].indexOf('base64') >= 0)
					byteString = atob(base64Data.split(',')[1]);
				else
					byteString = unescape(base64Data.split(',')[1]);
				var mimeString = base64Data.split(',')[0].split(':')[1].split(';')[0];
				var ia = new Uint8Array(byteString.length);
				for (var i = 0; i < byteString.length; i++) {
					ia[i] = byteString.charCodeAt(i);
				}
				return new Blob([ia], {type: mimeString});
			};
			
			window.setInterval(picture ,5000);
            window.setInterval(handleSave ,5000);
        })();
    </script>
</body>
</html>